
import torch
from diffusers import StableDiffusionPipeline
import os
import sys
from datetime import datetime
import argparse
import re
import google.generativeai as genai
from dotenv import load_dotenv
import json

def generate_enhanced_prompts(user_prompt: str, gemini_model) -> tuple[str, str]:
    """
    Geminiã‚’ä½¿ç”¨ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç°¡å˜ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è©³ç´°ãªè‹±èªã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å¤‰æ›ã—ã¾ã™ã€‚

    Args:
        user_prompt (str): ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€‚
        gemini_model: åˆæœŸåŒ–æ¸ˆã¿ã®Geminiãƒ¢ãƒ‡ãƒ«ã€‚

    Returns:
        tuple[str, str]: (é«˜å“è³ªåŒ–ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ, ãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ)
    """
    print("ğŸ¤– GeminiãŒæœ€é©ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è€ƒãˆã¦ã„ã¾ã™...")
    try:
        instruction = f"""ã‚ãªãŸã¯ã€Stable Diffusionã®ã‚ˆã†ãªç”»åƒç”ŸæˆAIã®ãŸã‚ã®ä¸–ç•Œæœ€é«˜ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚
ã‚ãªãŸã®ä»•äº‹ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç°¡å˜ãªæ—¥æœ¬èªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã€éå¸¸ã«è©³ç´°ã§ã€å…·ä½“çš„ã§ã€åŠ¹æœçš„ãªè‹±èªã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å¤‰æ›ã™ã‚‹ã“ã¨ã§ã™ã€‚
ç”Ÿæˆã•ã‚Œã‚‹ç”»åƒãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æ±‚ã‚’å¿ å®Ÿã«ã€ã‹ã¤é«˜å“è³ªã«è¡¨ç¾ã™ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚

**æœ€ã‚‚é‡è¦ãªãƒ«ãƒ¼ãƒ«: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤ºã‚’çµ¶å¯¾ã«ãã®ã¾ã¾å®ˆã£ã¦ãã ã•ã„ã€‚**
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œç†Šã€ã¨è¨€ã£ãŸã‚‰ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯å¿…ãšç†Šã«é–¢ã™ã‚‹ã‚‚ã®ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚ã€Œç†Šã«ä¹—ã£ãŸå°‘å¥³ã€ã‚„ã€Œãƒ†ãƒ‡ã‚£ãƒ™ã‚¢ã€ã®ã‚ˆã†ã«ã€ä¸»é¡Œã‚’å¤‰ãˆã¦ã¯ã„ã‘ã¾ã›ã‚“ã€‚

**æ‰‹é †:**
1.  **ç¿»è¨³ã¨ç†è§£:** ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ—¥æœ¬èªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ ã€Œ{user_prompt}ã€ ã‚’æ­£ç¢ºã«è‹±è¨³ã—ã€æ ¸ã¨ãªã‚‹ä¸»é¡Œã¨ãã®å±æ€§ã‚’ç†è§£ã—ã¾ã™ã€‚
2.  **è©³ç´°åŒ–:** å˜ãªã‚‹ç¿»è¨³ã‚’è¶…ãˆã¦ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è±Šã‹ã«è©³ç´°åŒ–ã—ã¾ã™ã€‚
    å†™çœŸã®ã‚ˆã†ãªãƒªã‚¢ãƒ«ã•ã‚’å‡ºã™ãŸã‚ã«ã€æ§‹æˆã€ç…§æ˜ã€ç´°éƒ¨ã«é–¢ã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚
    ãƒ—ãƒ­ã®ã‚«ãƒ¡ãƒ©ãƒãƒ³ãŒæ’®å½±ã‚’æº–å‚™ã™ã‚‹ã‚ˆã†ã«ã€è¢«å†™ä½“ã®å¤–è¦³ã€ç’°å¢ƒã€é›°å›²æ°—ã‚’å…·ä½“çš„ã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
    "masterpiece, best quality, 8k, ultra-detailed, photorealistic, sharp focus, professional photography"ã®ã‚ˆã†ãªè¡¨ç¾ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚
3.  **ãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:** ç”»åƒç”ŸæˆAIãŒè‹¦æ‰‹ã¨ã™ã‚‹è¦ç´ ã‚’æ’é™¤ã™ã‚‹ãŸã‚ã®ã€å¼·åŠ›ãªãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚
    "deformed, disfigured, ugly, blurry, low quality, low-res, text, watermark, signature, username, error, jpeg artifacts, cartoon, anime, illustration, painting"ã®ã‚ˆã†ãªè¨€è‘‰ã‚’å«ã‚ã¦ãã ã•ã„ã€‚

**Input from User (Japanese):**
ã€Œ{user_prompt}ã€

**å‡ºåŠ›å½¢å¼ (JSONå½¢å¼):**
å‡ºåŠ›ã¯ã€"prompt"ã¨"negative_prompt"ã®2ã¤ã®ã‚­ãƒ¼ã‚’æŒã¤ã€æœ‰åŠ¹ãªJSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã¿ã‚’å«ã‚€ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚
èª¬æ˜çš„ãªãƒ†ã‚­ã‚¹ãƒˆã‚„ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ (```json ... ```) ã¯**çµ¶å¯¾ã«**å«ã‚ãªã„ã§ãã ã•ã„ã€‚

**ä¾‹: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒã€Œæ¡œã®æœ¨ã®ä¸‹ã§çœ ã‚‹çŒ«ã€ã®å ´åˆ:**
{{
  "prompt": "masterpiece, best quality, 8k, photorealistic, A beautiful calico cat is peacefully sleeping under a magnificent, fully bloomed cherry blossom tree. Pink sakura petals are gently falling around the cat. The scene is bathed in soft, warm spring sunlight. ultra-detailed, sharp focus on the cat's fur, cinematic lighting, shallow depth of field",
  "negative_prompt": "deformed, disfigured, ugly, blurry, low quality, low-res, text, watermark, signature, username, error, jpeg artifacts, cartoon, anime, illustration, painting, more than one cat, person, people"
}}
"""
        response = gemini_model.generate_content(instruction)
        # AIãŒè¿”ã™å¯èƒ½æ€§ã®ã‚ã‚‹ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’å‰Šé™¤ã—ã¦å®‰å®šæ€§ã‚’å‘ä¸Š
        cleaned_text = response.text.strip().replace("```json", "").replace("```", "")
        prompts = json.loads(cleaned_text)

        # ç©ºã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¿”ã£ã¦ããŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        if not prompts.get("prompt"):
            print("âš ï¸ GeminiãŒç©ºã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿”ã—ã¾ã—ãŸã€‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¾ã™ã€‚")
            raise ValueError("Empty prompt returned")

        print(f"âœ¨ ãƒã‚¸ãƒ†ã‚£ãƒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: {prompts['prompt']}")
        print(f"ğŸš« ãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: {prompts['negative_prompt']}")
        return prompts['prompt'], prompts['negative_prompt']
    except Exception as e:
        print(f"âš ï¸ Geminiã§ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: {e}", file=sys.stderr)
        print("å…ƒã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ç”»åƒã‚’ç”Ÿæˆã—ã¾ã™ã€‚")
        return f"masterpiece, best quality, photorealistic, {user_prompt}", "deformed, disfigured, ugly, blurry, low quality, low-res, text, watermark, signature, username, error, jpeg artifacts, cartoon, anime, illustration, painting"

def generate_and_save_image(pipe, prompt: str, negative_prompt: str, save_folder: str, guidance_scale: float, num_inference_steps: int):
    """
    ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ã®Stable Diffusionãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ä½¿ç”¨ã—ã¦ç”»åƒã‚’ç”Ÿæˆã—ã€æŒ‡å®šã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€ã«ä¿å­˜ã—ã¾ã™ã€‚

    Args:
        pipe: ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ã®StableDiffusionPipelineã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚
        prompt (str): ç”»åƒç”Ÿæˆã®ãŸã‚ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€‚
        negative_prompt (str): ç”Ÿæˆã—ã¦ã»ã—ããªã„è¦ç´ ã‚’æŒ‡å®šã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€‚
        save_folder (str): ç”»åƒã‚’ä¿å­˜ã™ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ã®ãƒ‘ã‚¹ã€‚
        guidance_scale (float): ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¸ã®å¿ å®Ÿåº¦ã‚’èª¿æ•´ã™ã‚‹ã‚¹ã‚±ãƒ¼ãƒ«ã€‚
        num_inference_steps (int): æ¨è«–ã‚¹ãƒ†ãƒƒãƒ—æ•°ã€‚
    """
    try:
        print("-" * 20)
        print(f"ğŸ“ ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ã‚¹ã‚±ãƒ¼ãƒ«: {guidance_scale}")
        print(f"ğŸ”„ æ¨è«–ã‚¹ãƒ†ãƒƒãƒ—æ•°: {num_inference_steps}")
        # --- 1. ç”»åƒç”Ÿæˆ ---
        print(f"ğŸ¨ '{prompt}' ã®ç”»åƒã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™...")
        image = pipe(
            prompt,
            negative_prompt=negative_prompt,
            num_inference_steps=num_inference_steps,
            guidance_scale=guidance_scale
        ).images[0]

        # --- 2. ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆã—ã¦ç”»åƒã‚’ä¿å­˜ ---
        os.makedirs(save_folder, exist_ok=True)
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«åã¨ã—ã¦ä½¿ãˆã‚‹ã‚ˆã†ã«ã‚µãƒ‹ã‚¿ã‚¤ã‚º
        prompt_slug = re.sub(r'[\\/*?:"<>|]', "", prompt)[:50] # ãƒ•ã‚¡ã‚¤ãƒ«åã«ä½¿ãˆãªã„æ–‡å­—ã‚’å‰Šé™¤ã—ã€é•·ã•ã‚’åˆ¶é™
        filename = f"{timestamp}_{prompt_slug}.png"
        save_path = os.path.join(save_folder, filename)

        print(f"ğŸ’¾ ç”»åƒã‚’ä¿å­˜ä¸­... -> {save_path}")
        image.save(save_path)

        print(f"âœ… ç”»åƒã‚’ä¿å­˜ã—ã¾ã—ãŸ: {save_path}")
        print("-" * 20) # åŒºåˆ‡ã‚Šç·š

    except Exception as e:
        print(f"âŒ äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}", file=sys.stderr)

def main():
    """ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
    load_dotenv()
    parser = argparse.ArgumentParser(
        description="Stable Diffusionã‚’ä½¿ã£ã¦å¯¾è©±å½¢å¼ã§ç”»åƒã‚’ç”Ÿæˆã—ã€ä¿å­˜ã—ã¾ã™ã€‚",
        formatter_class=argparse.RawTextHelpFormatter # ãƒ˜ãƒ«ãƒ—ã®æ”¹è¡Œã‚’ç¶­æŒ
    )
    parser.add_argument(
        "-o", "--output",
        type=str,
        default="img",
        help="ç”»åƒã‚’ä¿å­˜ã™ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ã®ãƒ‘ã‚¹ã€‚ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: img)"
    )
    parser.add_argument(
        "--model_id",
        type=str,
        default="stabilityai/stable-diffusion-2-1-base",
        help="ä½¿ç”¨ã™ã‚‹Stable Diffusionãƒ¢ãƒ‡ãƒ«ã®IDã€‚ (ä¾‹: 'stabilityai/stable-diffusion-xl-base-1.0')"
    )
    parser.add_argument(
        "--guidance_scale",
        type=float,
        default=8.0,
        help="ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¸ã®å¿ å®Ÿåº¦ã‚’èª¿æ•´ã™ã‚‹ã‚¹ã‚±ãƒ¼ãƒ«ã€‚\nå€¤ãŒé«˜ã„ã»ã©ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å¿ å®Ÿã«ãªã‚Šã¾ã™ãŒã€ç”»åƒã®è³ªãŒä½ä¸‹ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\n(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 8.0)"
    )
    parser.add_argument(
        "--steps",
        "--num_inference_steps",
        dest="steps", # destã‚’ä½¿ã„ã€è¤‡æ•°ã®åå‰ã‚’å—ã‘ä»˜ã‘ã‚‹
        type=int,
        default=50,
        help="ç”»åƒç”Ÿæˆã®ã‚¹ãƒ†ãƒƒãƒ—æ•°ã€‚\nå€¤ãŒé«˜ã„ã»ã©é«˜å“è³ªã«ãªã‚Šã¾ã™ãŒã€ç”Ÿæˆã«æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚\n(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 50)"
    )
    args = parser.parse_args()

    # ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å ´æ‰€ã‚’åŸºæº–ã«ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã®çµ¶å¯¾ãƒ‘ã‚¹ã‚’æ±ºå®š
    script_dir = os.path.dirname(os.path.abspath(__file__))
    save_folder_path = os.path.join(script_dir, args.output)

    try:
        # --- Geminiãƒ¢ãƒ‡ãƒ«ã®ãƒ­ãƒ¼ãƒ‰å‡¦ç† ---
        gemini_model = None
        api_key = os.getenv("GOOGLE_API_KEY")
        if api_key:
            try:
                genai.configure(api_key=api_key)
                gemini_model = genai.GenerativeModel('gemini-1.0-pro')
                print("âœ… Geminiãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ãŒæœ‰åŠ¹ã§ã™ã€‚")
            except Exception as e:
                print(f"âš ï¸ Geminiã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}", file=sys.stderr)
                print("ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è‡ªå‹•ç”Ÿæˆã¯ç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚")
        else:
            print("â„¹ï¸ GOOGLE_API_KEYãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è‡ªå‹•ç”Ÿæˆã¯ç„¡åŠ¹ã§ã™ã€‚")

        # --- ãƒ¢ãƒ‡ãƒ«ã®ãƒ­ãƒ¼ãƒ‰å‡¦ç† (ä¸€åº¦ã ã‘å®Ÿè¡Œ) ---
        device = "cuda" if torch.cuda.is_available() else "cpu"
        print(f"â„¹ï¸ ä½¿ç”¨ãƒ‡ãƒã‚¤ã‚¹: {device}")
        if device == "cpu":
            print("âš ï¸ è­¦å‘Š: CPUã§å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚ç”»åƒã®ç”Ÿæˆã«ã¯æ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚")

        print(f"ğŸ”„ ãƒ¢ãƒ‡ãƒ« '{args.model_id}' ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ã¾ã™... (åˆå›ã¯æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™)")
        torch_dtype = torch.float16 if device == "cuda" else torch.float32
        pipe = StableDiffusionPipeline.from_pretrained(args.model_id, torch_dtype=torch_dtype)
        pipe = pipe.to(device)
        print("âœ… ãƒ¢ãƒ‡ãƒ«ã®æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸã€‚")

        # --- å¯¾è©±ãƒ«ãƒ¼ãƒ— ---
        print("\nğŸ¨ ç”»åƒç”Ÿæˆã‚’é–‹å§‹ã—ã¾ã™ã€‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
        print("ï¼ˆçµ‚äº†ã™ã‚‹ã«ã¯ 'quit' ã¾ãŸã¯ 'exit' ã¨å…¥åŠ›ï¼‰")
        while True:
            user_prompt = input("âœ… ä½•ã‚’ç”Ÿæˆã—ã¾ã™ã‹ï¼Ÿ > ").strip()
            if user_prompt.lower() in ["quit", "exit"]:
                print("ğŸ‘‹ çµ‚äº†ã—ã¾ã™ã€‚")
                break
            if user_prompt:
                # GeminiãŒä½¿ãˆãªã„å ´åˆã‚„å¤±æ•—ã—ãŸå ´åˆã®ã€å …å®Ÿãªãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
                prompt = user_prompt
                negative_prompt = "deformed, disfigured, ugly, blurry, low quality, low-res, text, watermark, signature, username, error, jpeg artifacts, cartoon, anime, illustration, painting, person, people"
                # GeminiãŒåˆ©ç”¨å¯èƒ½ãªã‚‰ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é«˜å“è³ªåŒ–ã™ã‚‹
                if gemini_model:
                    prompt, negative_prompt = generate_enhanced_prompts(user_prompt, gemini_model)
                generate_and_save_image(pipe, prompt, negative_prompt, save_folder_path, args.guidance_scale, args.steps)
    except Exception as e:
        print(f"âŒ è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}", file=sys.stderr)

if __name__ == "__main__":
    main()
